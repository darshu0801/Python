import pandas as pd

# Load the Excel file
file_path = 'Book3.xlsx'
sheet_name = 'data'
column_name = 'P_Avg'

# Read the specified sheet and column
df = pd.read_excel(file_path, sheet_name=sheet_name)

# Function to filter out short spikes
def filter_spikes(data, duration_threshold=15):
    filtered_data = data.copy()  # Create a copy of the data to modify
    i = 0

    while i < len(data):
        # Check if the current value is a spike (sudden increase)
        if i > 0 and data[i] > data[i - 1] + 0.1:  # Adjust the spike threshold as needed
            spike_start = i
            spike_value = data[i]

            # Check how long the spike lasts
            j = i + 1
            while j < len(data) and data[j] >= spike_value - 0.1:  # Allow minor fluctuations
                j += 1

            # Calculate the duration of the spike
            spike_duration = j - spike_start

            # If the spike lasts less than the duration threshold, replace values with 0
            if spike_duration < duration_threshold:
                filtered_data[spike_start:j] = 0
            i = j  # Skip the processed spike
        else:
            i += 1  # Move to the next value

    return filtered_data

# Apply the function to the specified column
df[column_name] = filter_spikes(df[column_name], duration_threshold=15)

# Save the modified data back to the Excel file
output_file_path = 'Book3_filtered.xlsx'
df.to_excel(output_file_path, index=False, sheet_name=sheet_name)

print(f"Spike filtering complete. Modified data saved to {output_file_path}.")